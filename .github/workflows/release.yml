name: Release & Deploy

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build extension
        run: npm run ext:build

      - name: Build backend
        run: npm run backend:build

      - name: Create extension zip
        run: |
          cd extension/dist
          zip -r ../mailguard-extension-${{ github.ref_name }}.zip .
          cd ../..

      - name: Create backend zip
        run: |
          cd backend
          zip -r ../mailguard-backend-${{ github.ref_name }}.zip dist/ package.json package-lock.json
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mailguard-extension-${{ github.ref_name }}.zip
            mailguard-backend-${{ github.ref_name }}.zip
            coverage/lcov.info
          body: |
            ## MailGuard ${{ github.ref_name }} Release
            
            ### Artifacts
            - `mailguard-extension-${{ github.ref_name }}.zip` - Browser extension build
            - `mailguard-backend-${{ github.ref_name }}.zip` - Backend server build
            
            ### Changes
            See commit log for detailed changes.
            
            ### Installation
            1. Download the extension zip
            2. Extract to a folder
            3. Go to `chrome://extensions/` or `brave://extensions/`
            4. Enable Developer Mode
            5. Click "Load unpacked" and select the extracted folder
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: mailguard:${{ github.ref_name }}
          outputs: type=docker,dest=/tmp/image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar

  create-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          echo "## Changelog" > CHANGELOG_TEMP.md
          git log $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD --oneline >> CHANGELOG_TEMP.md || true
          cat CHANGELOG_TEMP.md

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG_TEMP.md
